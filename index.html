<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskDrop - Send tasks. Get notified when done.</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Fraunces:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwindcss.config = {
            theme: {
                extend: {
                    colors: {
                        'drop': {
                            'dark': '#1a1a2e',
                            'navy': '#16213e',
                            'accent': '#e94560',
                            'accent2': '#ff6b6b',
                            'light': '#f5f5f7',
                            'muted': '#8892b0',
                            'success': '#00d26a',
                            'warning': '#ffc107'
                        }
                    },
                    fontFamily: {
                        'display': ['Fraunces', 'serif'],
                        'body': ['DM Sans', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: #1a1a2e; color: #f5f5f7; min-height: 100vh; }
        .gradient-bg { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%); }
        .card-glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .progress-bar { background: rgba(255, 255, 255, 0.1); border-radius: 100px; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, #e94560, #ff6b6b); height: 100%; border-radius: 100px; transition: width 0.5s ease; }
        .btn-primary { background: linear-gradient(135deg, #e94560, #ff6b6b); transition: all 0.3s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(233, 69, 96, 0.3); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .input-field { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.2s ease; }
        .input-field:focus { outline: none; border-color: #e94560; background: rgba(255, 255, 255, 0.08); }
        .fade-in { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .checkbox-custom { appearance: none; width: 24px; height: 24px; border: 2px solid #8892b0; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .checkbox-custom:checked { background: #00d26a; border-color: #00d26a; }
        .checkbox-custom:checked::after { content: '✓'; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; height: 100%; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // API calls to Netlify Functions
        const API = {
            async createProject(data) {
                const res = await fetch('/.netlify/functions/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return res.json();
            },
            async getProjects(ownerEmail) {
                const res = await fetch(`/.netlify/functions/projects?owner=${encodeURIComponent(ownerEmail)}`);
                return res.json();
            },
            async getProject(id) {
                const res = await fetch(`/.netlify/functions/projects?id=${id}`);
                return res.json();
            },
            async createTask(data) {
                const res = await fetch('/.netlify/functions/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return res.json();
            },
            async getTaskByToken(token) {
                const res = await fetch(`/.netlify/functions/tasks?token=${token}`);
                return res.json();
            },
            async getProjectTasks(projectId) {
                const res = await fetch(`/.netlify/functions/tasks?project_id=${projectId}`);
                return res.json();
            },
            async completeTask(token, notes) {
                const res = await fetch('/.netlify/functions/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, notes })
                });
                return res.json();
            },
            async deleteTask(id) {
                const res = await fetch(`/.netlify/functions/tasks?id=${id}`, { method: 'DELETE' });
                return res.json();
            },
            async deleteProject(id) {
                const res = await fetch(`/.netlify/functions/projects?id=${id}`, { method: 'DELETE' });
                return res.json();
            }
        };

        // Icons
        const Icons = {
            Plus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
            Check: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
            Link: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>,
            Location: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
            Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
            Back: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>,
            Send: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>,
            Mail: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>,
            Copy: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
            Project: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>,
            User: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
        };

        // Toast notification
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => { const t = setTimeout(onClose, 4000); return () => clearTimeout(t); }, []);
            return (
                <div className={`fixed bottom-6 right-6 card-glass rounded-xl p-4 pr-6 flex items-center gap-3 fade-in z-50 ${type === 'success' ? 'border-drop-success/50' : type === 'error' ? 'border-red-500/50' : 'border-drop-accent/50'}`}>
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center ${type === 'success' ? 'bg-drop-success/20 text-drop-success' : type === 'error' ? 'bg-red-500/20 text-red-500' : 'bg-drop-accent/20 text-drop-accent'}`}>
                        <Icons.Check />
                    </div>
                    <p className="font-medium">{message}</p>
                    <button onClick={onClose} className="ml-4 text-drop-muted hover:text-white">×</button>
                </div>
            );
        };

        // Progress Bar
        const ProgressBar = ({ completed, total }) => {
            const pct = total > 0 ? (completed / total) * 100 : 0;
            return (
                <div className="w-full">
                    <div className="flex justify-between text-sm mb-2">
                        <span className="text-drop-muted">{completed} of {total} tasks</span>
                        <span className="text-drop-accent font-medium">{Math.round(pct)}%</span>
                    </div>
                    <div className="progress-bar h-2">
                        <div className="progress-fill" style={{ width: `${pct}%` }}></div>
                    </div>
                </div>
            );
        };

        // ============ TASK COMPLETION VIEW (Public - accessed via token link) ============
        const TaskCompletionView = ({ token }) => {
            const [task, setTask] = useState(null);
            const [project, setProject] = useState(null);
            const [allTasks, setAllTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [completing, setCompleting] = useState(false);
            const [notes, setNotes] = useState('');
            const [confirmed, setConfirmed] = useState(false);
            const [done, setDone] = useState(false);
            const [error, setError] = useState(null);

            useEffect(() => {
                loadTask();
            }, [token]);

            const loadTask = async () => {
                try {
                    const data = await API.getTaskByToken(token);
                    if (data.error) {
                        setError(data.error);
                    } else {
                        setTask(data.task);
                        setProject(data.project);
                        setAllTasks(data.allTasks || []);
                        if (data.task.completed) setDone(true);
                    }
                } catch (e) {
                    setError('Failed to load task');
                }
                setLoading(false);
            };

            const handleComplete = async () => {
                if (!confirmed) return;
                setCompleting(true);
                try {
                    const result = await API.completeTask(token, notes);
                    if (result.success) {
                        setDone(true);
                    } else {
                        setError(result.error || 'Failed to complete task');
                    }
                } catch (e) {
                    setError('Failed to complete task');
                }
                setCompleting(false);
            };

            if (loading) {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center">
                        <div className="text-center">
                            <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-drop-accent to-drop-accent2 flex items-center justify-center mx-auto mb-4 animate-pulse">
                                <Icons.Send />
                            </div>
                            <p className="text-drop-muted">Loading task...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center p-6">
                        <div className="card-glass rounded-2xl p-8 text-center max-w-md">
                            <div className="w-16 h-16 rounded-2xl bg-red-500/20 flex items-center justify-center mx-auto mb-4">
                                <span className="text-3xl">❌</span>
                            </div>
                            <h1 className="font-display text-2xl mb-2">Task Not Found</h1>
                            <p className="text-drop-muted">{error}</p>
                        </div>
                    </div>
                );
            }

            if (done) {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center p-6">
                        <div className="card-glass rounded-2xl p-8 text-center max-w-md fade-in">
                            <div className="w-20 h-20 rounded-full bg-drop-success/20 flex items-center justify-center mx-auto mb-6">
                                <span className="text-4xl">✓</span>
                            </div>
                            <h1 className="font-display text-3xl mb-2">Task Complete!</h1>
                            <p className="text-drop-muted mb-4">"{task.title}"</p>
                            <p className="text-drop-success">The task owner has been notified.</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen gradient-bg p-6">
                    <div className="max-w-2xl mx-auto">
                        {/* Header */}
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-drop-accent to-drop-accent2 flex items-center justify-center mx-auto mb-4">
                                <Icons.Project />
                            </div>
                            {project && (
                                <>
                                    <h1 className="font-display text-2xl mb-1">{project.name}</h1>
                                    {project.description && <p className="text-drop-muted">{project.description}</p>}
                                </>
                            )}
                        </div>

                        {/* All Tasks in Project */}
                        {allTasks.length > 1 && (
                            <div className="card-glass rounded-2xl p-6 mb-6">
                                <h3 className="text-sm text-drop-muted uppercase tracking-wider mb-4">All Tasks in This Project</h3>
                                <ProgressBar completed={allTasks.filter(t => t.completed).length} total={allTasks.length} />
                                <div className="mt-4 space-y-2">
                                    {allTasks.map(t => (
                                        <div key={t.id} className={`flex items-center gap-3 p-3 rounded-lg ${t.id === task.id ? 'bg-drop-accent/10 border border-drop-accent/30' : 'bg-white/5'}`}>
                                            <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${t.completed ? 'bg-drop-success border-drop-success' : 'border-drop-muted'}`}>
                                                {t.completed && <Icons.Check />}
                                            </div>
                                            <span className={t.completed ? 'line-through text-drop-muted' : ''}>{t.title}</span>
                                            {t.assignee_name && (
                                                <span className="ml-auto text-sm text-drop-muted flex items-center gap-1">
                                                    <Icons.User /> {t.assignee_name}
                                                </span>
                                            )}
                                            {t.id === task.id && <span className="text-xs bg-drop-accent/20 text-drop-accent px-2 py-1 rounded">Your Task</span>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Your Task */}
                        <div className="card-glass rounded-2xl p-6 mb-6">
                            <h2 className="text-sm text-drop-muted uppercase tracking-wider mb-2">Your Task</h2>
                            <h3 className="font-display text-2xl mb-4">{task.title}</h3>
                            
                            {task.details && (
                                <div className="mb-4">
                                    <p className="text-drop-muted">{task.details}</p>
                                </div>
                            )}

                            {task.links && task.links.length > 0 && (
                                <div className="flex flex-wrap gap-2 mb-4">
                                    {task.links.map((link, i) => (
                                        <a key={i} href={link} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-1 text-sm text-drop-accent hover:text-drop-accent2 bg-drop-accent/10 px-3 py-1.5 rounded-lg">
                                            <Icons.Link /> {(() => { try { return new URL(link).hostname; } catch { return 'Link'; } })()}
                                        </a>
                                    ))}
                                </div>
                            )}

                            {task.location && (
                                <a href={`https://maps.google.com/?q=${encodeURIComponent(task.location)}`} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 text-sm text-drop-accent hover:text-drop-accent2 bg-drop-accent/10 px-3 py-1.5 rounded-lg">
                                    <Icons.Location /> {task.location}
                                </a>
                            )}
                        </div>

                        {/* Completion Form */}
                        <div className="card-glass rounded-2xl p-6">
                            <h3 className="font-display text-xl mb-4">Mark as Complete</h3>
                            
                            <div className="mb-4">
                                <label className="block text-sm text-drop-muted mb-2">Notes (optional)</label>
                                <textarea
                                    value={notes}
                                    onChange={(e) => setNotes(e.target.value)}
                                    className="input-field w-full px-4 py-3 rounded-lg text-drop-light resize-none"
                                    placeholder="Any notes about the completed task..."
                                    rows={3}
                                />
                            </div>

                            <label className="flex items-center gap-3 mb-6 cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={confirmed}
                                    onChange={(e) => setConfirmed(e.target.checked)}
                                    className="checkbox-custom"
                                />
                                <span>I confirm this task is complete</span>
                            </label>

                            <button
                                onClick={handleComplete}
                                disabled={!confirmed || completing}
                                className="w-full btn-primary px-6 py-4 rounded-xl font-medium text-lg flex items-center justify-center gap-2"
                            >
                                {completing ? 'Sending...' : 'Complete Task'}
                            </button>
                        </div>

                        <div className="text-center mt-8 pt-6 border-t border-white/10">
                            <p className="text-drop-muted text-sm">Powered by <span className="text-drop-accent font-display">TaskDrop</span></p>
                        </div>
                    </div>
                </div>
            );
        };

        // ============ PROJECT VIEW (for project links) ============
        const ProjectView = ({ projectId }) => {
            const [project, setProject] = useState(null);
            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                loadProject();
            }, [projectId]);

            const loadProject = async () => {
                try {
                    const projData = await API.getProject(projectId);
                    if (projData.error) {
                        setError(projData.error);
                    } else {
                        setProject(projData);
                        const tasksData = await API.getProjectTasks(projectId);
                        setTasks(tasksData);
                    }
                } catch (e) {
                    setError('Failed to load project');
                }
                setLoading(false);
            };

            if (loading) {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center">
                        <p className="text-drop-muted">Loading project...</p>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center p-6">
                        <div className="card-glass rounded-2xl p-8 text-center">
                            <h1 className="font-display text-2xl mb-2">Project Not Found</h1>
                            <p className="text-drop-muted">{error}</p>
                        </div>
                    </div>
                );
            }

            const completed = tasks.filter(t => t.completed).length;

            return (
                <div className="min-h-screen gradient-bg p-6">
                    <div className="max-w-2xl mx-auto">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-drop-accent to-drop-accent2 flex items-center justify-center mx-auto mb-4">
                                <Icons.Project />
                            </div>
                            <h1 className="font-display text-3xl mb-2">{project.name}</h1>
                            {project.description && <p className="text-drop-muted">{project.description}</p>}
                        </div>

                        <div className="card-glass rounded-2xl p-6 mb-6">
                            <ProgressBar completed={completed} total={tasks.length} />
                        </div>

                        <div className="space-y-3">
                            {tasks.map(task => (
                                <div key={task.id} className={`card-glass rounded-xl p-4 ${task.completed ? 'opacity-70' : ''}`}>
                                    <div className="flex items-start gap-3">
                                        <div className={`mt-1 w-6 h-6 rounded-full border-2 flex items-center justify-center ${task.completed ? 'bg-drop-success border-drop-success' : 'border-drop-muted'}`}>
                                            {task.completed && <Icons.Check />}
                                        </div>
                                        <div className="flex-1">
                                            <h4 className={`font-medium ${task.completed ? 'line-through text-drop-muted' : ''}`}>{task.title}</h4>
                                            {task.assignee_name && (
                                                <p className="text-sm text-drop-muted mt-1">
                                                    Assigned to: <span className="text-drop-accent2">{task.assignee_name}</span>
                                                    {task.completed && <span className="text-drop-success ml-2">✓ Done</span>}
                                                </p>
                                            )}
                                            {task.completion_notes && (
                                                <p className="text-sm text-drop-muted mt-2 italic">"{task.completion_notes}"</p>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {tasks.length === 0 && (
                            <div className="card-glass rounded-2xl p-8 text-center">
                                <p className="text-drop-muted">No tasks in this project yet.</p>
                            </div>
                        )}

                        <div className="text-center mt-8 pt-6 border-t border-white/10">
                            <p className="text-drop-muted text-sm">Powered by <span className="text-drop-accent font-display">TaskDrop</span></p>
                        </div>
                    </div>
                </div>
            );
        };

        // ============ DASHBOARD (Owner View) ============
        const Dashboard = () => {
            const [ownerEmail, setOwnerEmail] = useState(() => localStorage.getItem('taskdrop-owner-email') || '');
            const [isLoggedIn, setIsLoggedIn] = useState(() => !!localStorage.getItem('taskdrop-owner-email'));
            const [projects, setProjects] = useState([]);
            const [selectedProject, setSelectedProject] = useState(null);
            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(false);
            const [showNewProject, setShowNewProject] = useState(false);
            const [showNewTask, setShowNewTask] = useState(false);
            const [toast, setToast] = useState(null);

            // New project form
            const [newProjectName, setNewProjectName] = useState('');
            const [newProjectDesc, setNewProjectDesc] = useState('');

            // New task form
            const [newTaskTitle, setNewTaskTitle] = useState('');
            const [newTaskDetails, setNewTaskDetails] = useState('');
            const [newTaskAssigneeName, setNewTaskAssigneeName] = useState('');
            const [newTaskAssigneeEmail, setNewTaskAssigneeEmail] = useState('');
            const [newTaskLinks, setNewTaskLinks] = useState([]);
            const [newTaskLinkInput, setNewTaskLinkInput] = useState('');
            const [newTaskLocation, setNewTaskLocation] = useState('');
            const [sendingTask, setSendingTask] = useState(false);

            useEffect(() => {
                if (isLoggedIn) loadProjects();
            }, [isLoggedIn]);

            const loadProjects = async () => {
                setLoading(true);
                const data = await API.getProjects(ownerEmail);
                setProjects(Array.isArray(data) ? data : []);
                setLoading(false);
            };

            const loadProjectTasks = async (projectId) => {
                const data = await API.getProjectTasks(projectId);
                setTasks(Array.isArray(data) ? data : []);
            };

            const handleLogin = (e) => {
                e.preventDefault();
                if (!ownerEmail.trim()) return;
                localStorage.setItem('taskdrop-owner-email', ownerEmail.trim());
                setIsLoggedIn(true);
            };

            const handleCreateProject = async (e) => {
                e.preventDefault();
                if (!newProjectName.trim()) return;
                const result = await API.createProject({
                    name: newProjectName.trim(),
                    description: newProjectDesc.trim(),
                    owner_email: ownerEmail
                });
                if (result.id) {
                    setProjects([result, ...projects]);
                    setNewProjectName('');
                    setNewProjectDesc('');
                    setShowNewProject(false);
                    setToast({ message: 'Project created!', type: 'success' });
                }
            };

            const handleCreateTask = async (e) => {
                e.preventDefault();
                if (!newTaskTitle.trim() || !newTaskAssigneeEmail.trim()) return;
                setSendingTask(true);
                const result = await API.createTask({
                    project_id: selectedProject.id,
                    title: newTaskTitle.trim(),
                    details: newTaskDetails.trim(),
                    assignee_name: newTaskAssigneeName.trim(),
                    assignee_email: newTaskAssigneeEmail.trim(),
                    links: newTaskLinks,
                    location: newTaskLocation.trim()
                });
                setSendingTask(false);
                if (result.id) {
                    setTasks([...tasks, result]);
                    setNewTaskTitle('');
                    setNewTaskDetails('');
                    setNewTaskAssigneeName('');
                    setNewTaskAssigneeEmail('');
                    setNewTaskLinks([]);
                    setNewTaskLocation('');
                    setShowNewTask(false);
                    setToast({ message: `Task sent to ${result.assignee_email}!`, type: 'success' });
                } else {
                    setToast({ message: result.error || 'Failed to create task', type: 'error' });
                }
            };

            const handleSelectProject = async (project) => {
                setSelectedProject(project);
                await loadProjectTasks(project.id);
            };

            const handleDeleteTask = async (taskId) => {
                await API.deleteTask(taskId);
                setTasks(tasks.filter(t => t.id !== taskId));
                setToast({ message: 'Task deleted', type: 'info' });
            };

            const handleDeleteProject = async (projectId) => {
                await API.deleteProject(projectId);
                setProjects(projects.filter(p => p.id !== projectId));
                setSelectedProject(null);
                setTasks([]);
                setToast({ message: 'Project deleted', type: 'info' });
            };

            const copyTaskLink = (token) => {
                const url = `${window.location.origin}?task=${token}`;
                navigator.clipboard.writeText(url);
                setToast({ message: 'Link copied!', type: 'success' });
            };

            const copyProjectLink = (projectId) => {
                const url = `${window.location.origin}?project=${projectId}`;
                navigator.clipboard.writeText(url);
                setToast({ message: 'Project link copied!', type: 'success' });
            };

            // Login screen
            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center p-6">
                        <div className="card-glass rounded-2xl p-8 w-full max-w-md fade-in">
                            <div className="text-center mb-8">
                                <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-drop-accent to-drop-accent2 flex items-center justify-center mx-auto mb-4">
                                    <Icons.Send />
                                </div>
                                <h1 className="font-display text-3xl mb-2">TaskDrop</h1>
                                <p className="text-drop-muted">Send tasks. Get notified when done.</p>
                            </div>
                            <form onSubmit={handleLogin}>
                                <label className="block text-sm text-drop-muted mb-2">Your Email</label>
                                <input
                                    type="email"
                                    value={ownerEmail}
                                    onChange={(e) => setOwnerEmail(e.target.value)}
                                    className="input-field w-full px-4 py-3 rounded-lg text-drop-light mb-4"
                                    placeholder="you@example.com"
                                    required
                                />
                                <button type="submit" className="w-full btn-primary px-6 py-3 rounded-xl font-medium">
                                    Get Started
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            // Project detail view
            if (selectedProject) {
                const completed = tasks.filter(t => t.completed).length;
                return (
                    <div className="min-h-screen gradient-bg">
                        <header className="border-b border-white/10">
                            <div className="max-w-4xl mx-auto px-6 py-4 flex items-center justify-between">
                                <button onClick={() => { setSelectedProject(null); setTasks([]); }} className="flex items-center gap-2 text-drop-muted hover:text-white">
                                    <Icons.Back /> Back
                                </button>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => copyProjectLink(selectedProject.id)} className="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 flex items-center gap-2 text-sm">
                                        <Icons.Copy /> Share Project
                                    </button>
                                    <button onClick={() => handleDeleteProject(selectedProject.id)} className="px-3 py-2 rounded-lg border border-drop-accent/50 text-drop-accent hover:bg-drop-accent/10 flex items-center gap-2 text-sm">
                                        <Icons.Trash /> Delete
                                    </button>
                                </div>
                            </div>
                        </header>

                        <main className="max-w-4xl mx-auto px-6 py-8">
                            <div className="mb-8">
                                <h1 className="font-display text-3xl mb-2">{selectedProject.name}</h1>
                                {selectedProject.description && <p className="text-drop-muted">{selectedProject.description}</p>}
                            </div>

                            <div className="card-glass rounded-2xl p-6 mb-8">
                                <ProgressBar completed={completed} total={tasks.length} />
                            </div>

                            <div className="flex items-center justify-between mb-6">
                                <h2 className="font-display text-xl">Tasks</h2>
                                <button onClick={() => setShowNewTask(true)} className="btn-primary px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                                    <Icons.Plus /> Add Task
                                </button>
                            </div>

                            {tasks.length === 0 ? (
                                <div className="card-glass rounded-2xl p-8 text-center">
                                    <p className="text-drop-muted mb-4">No tasks yet. Add a task and send it to someone!</p>
                                    <button onClick={() => setShowNewTask(true)} className="btn-primary px-5 py-2.5 rounded-lg font-medium inline-flex items-center gap-2">
                                        <Icons.Plus /> Add Task
                                    </button>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {tasks.map(task => (
                                        <div key={task.id} className={`card-glass rounded-xl p-4 ${task.completed ? 'opacity-70' : ''}`}>
                                            <div className="flex items-start gap-3">
                                                <div className={`mt-1 w-6 h-6 rounded-full border-2 flex items-center justify-center ${task.completed ? 'bg-drop-success border-drop-success' : 'border-drop-muted'}`}>
                                                    {task.completed && <Icons.Check />}
                                                </div>
                                                <div className="flex-1">
                                                    <div className="flex items-center justify-between">
                                                        <h4 className={`font-medium ${task.completed ? 'line-through text-drop-muted' : ''}`}>{task.title}</h4>
                                                        <div className="flex items-center gap-1">
                                                            <button onClick={() => copyTaskLink(task.token)} className="text-drop-muted hover:text-drop-accent p-1" title="Copy task link">
                                                                <Icons.Copy />
                                                            </button>
                                                            <button onClick={() => handleDeleteTask(task.id)} className="text-drop-muted hover:text-drop-accent p-1" title="Delete task">
                                                                <Icons.Trash />
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <p className="text-sm text-drop-muted mt-1">
                                                        {task.assignee_name && <span className="text-drop-accent2">{task.assignee_name}</span>}
                                                        {task.assignee_name && task.assignee_email && ' • '}
                                                        {task.assignee_email && <span>{task.assignee_email}</span>}
                                                        {task.sms_sent && <span className="text-drop-success ml-2">✓ Email sent</span>}
                                                    </p>
                                                    {task.completed && task.completion_notes && (
                                                        <p className="text-sm text-drop-muted mt-2 italic bg-white/5 p-2 rounded">"{task.completion_notes}"</p>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </main>

                        {/* Add Task Modal */}
                        {showNewTask && (
                            <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
                                <div className="card-glass rounded-2xl p-6 w-full max-w-md fade-in max-h-[90vh] overflow-y-auto">
                                    <h3 className="font-display text-2xl mb-6">Add & Send Task</h3>
                                    <form onSubmit={handleCreateTask}>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm text-drop-muted mb-2">Task Title *</label>
                                                <input type="text" value={newTaskTitle} onChange={(e) => setNewTaskTitle(e.target.value)} className="input-field w-full px-4 py-3 rounded-lg text-drop-light" placeholder="What needs to be done?" required />
                                            </div>
                                            <div>
                                                <label className="block text-sm text-drop-muted mb-2">Details</label>
                                                <textarea value={newTaskDetails} onChange={(e) => setNewTaskDetails(e.target.value)} className="input-field w-full px-4 py-3 rounded-lg text-drop-light resize-none" placeholder="Instructions, context..." rows={3} />
                                            </div>
                                            <div>
                                                <label className="block text-sm text-drop-muted mb-2">Assignee Name</label>
                                                <input type="text" value={newTaskAssigneeName} onChange={(e) => setNewTaskAssigneeName(e.target.value)} className="input-field w-full px-4 py-3 rounded-lg text-drop-light" placeholder="John" />
                                            </div>
                                            <div>
                                                <label className="block text-sm text-drop-muted mb-2">Assignee Email *</label>
                                                <input type="email" value={newTaskAssigneeEmail} onChange={(e) => setNewTaskAssigneeEmail(e.target.value)} className="input-field w-full px-4 py-3 rounded-lg text-drop-light" placeholder="john@example.com" required />
                                            </div>
                                            <div>
                                                <label className="block text-sm text-drop-muted mb-2">Links</label>
                                                <div className="flex gap-2">
                                                    <input type="url" value={newTaskLinkInput} onChange={(e) => setNewTaskLinkInput(e.target.value)} className="input-field flex-1 px-4 py-3 rounded-lg text-drop-light" placeholder="https://..." />
                                                    <button type="button" onClick={() => { if (newTaskLinkInput.startsWith('http')) { setNewTaskLinks([...newTaskLinks, newTaskLinkInput]); setNewTaskLinkInput(''); }}} className="px-4 py-3 rounded-lg bg-white/10 hover:bg-white/20">
                                                        <Icons.Plus />
                                                    </button>
                                                </div>
                                                {newTaskLinks.length > 0 && (
                                                    <div className="flex flex-wrap gap-2 mt-2">
                                                        {newTaskLinks.map((link, i) => (
                                                            <span key={i} className="text-xs bg-drop-accent/20 text-drop-accent px-2 py-1 rounded flex items-center gap-1">
                                                                {(() => { try { return new URL(link).hostname; } catch { return link.slice(0, 20); } })()}
                                                                <button type="button" onClick={() => setNewTaskLinks(newTaskLinks.filter((_, idx) => idx !== i))}>×</button>
                                                            </span>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                            <div>
                                                <label className="block text-sm text-drop-muted mb-2">Location</label>
                                                <input type="text" value={newTaskLocation} onChange={(e) => setNewTaskLocation(e.target.value)} className="input-field w-full px-4 py-3 rounded-lg text-drop-light" placeholder="Address or place" />
                                            </div>
                                        </div>
                                        <div className="flex gap-3 mt-6">
                                            <button type="button" onClick={() => setShowNewTask(false)} className="flex-1 px-4 py-3 rounded-lg border border-white/20 hover:bg-white/5">Cancel</button>
                                            <button type="submit" disabled={sendingTask} className="flex-1 btn-primary px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2">
                                                {sendingTask ? 'Sending...' : <><Icons.Mail /> Send Task</>}
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )}

                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    </div>
                );
            }

            // Projects list (dashboard)
            return (
                <div className="min-h-screen gradient-bg">
                    <header className="border-b border-white/10">
                        <div className="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-drop-accent to-drop-accent2 flex items-center justify-center">
                                    <Icons.Send />
                                </div>
                                <h1 className="font-display text-2xl">TaskDrop</h1>
                            </div>
                            <div className="flex items-center gap-4">
                                <span className="text-drop-muted text-sm">{ownerEmail}</span>
                                <button onClick={() => setShowNewProject(true)} className="btn-primary px-5 py-2.5 rounded-xl font-medium flex items-center gap-2">
                                    <Icons.Plus /> New Project
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto px-6 py-8">
                        <div className="mb-8">
                            <h2 className="text-drop-muted text-sm uppercase tracking-wider mb-1">Your Projects</h2>
                            <p className="text-2xl font-display">{projects.length === 0 ? 'No projects yet' : `${projects.length} project${projects.length !== 1 ? 's' : ''}`}</p>
                        </div>

                        {loading ? (
                            <p className="text-drop-muted">Loading...</p>
                        ) : projects.length === 0 ? (
                            <div className="card-glass rounded-2xl p-12 text-center">
                                <div className="w-20 h-20 rounded-2xl bg-gradient-to-br from-drop-accent/20 to-drop-accent2/20 flex items-center justify-center mx-auto mb-6">
                                    <Icons.Project />
                                </div>
                                <h3 className="font-display text-2xl mb-2">Create your first project</h3>
                                <p className="text-drop-muted mb-6">Organize tasks, send them to people, and track completion</p>
                                <button onClick={() => setShowNewProject(true)} className="btn-primary px-6 py-3 rounded-xl font-medium inline-flex items-center gap-2">
                                    <Icons.Plus /> Create Project
                                </button>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {projects.map(project => (
                                    <div key={project.id} onClick={() => handleSelectProject(project)} className="card-glass rounded-2xl p-6 cursor-pointer hover:bg-white/5 transition-all hover:transform hover:scale-[1.02]">
                                        <div className="flex items-start justify-between mb-4">
                                            <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-drop-accent to-drop-accent2 flex items-center justify-center">
                                                <Icons.Project />
                                            </div>
                                        </div>
                                        <h3 className="font-display text-xl mb-2">{project.name}</h3>
                                        {project.description && <p className="text-drop-muted text-sm mb-4 line-clamp-2">{project.description}</p>}
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* New Project Modal */}
                    {showNewProject && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
                            <div className="card-glass rounded-2xl p-6 w-full max-w-md fade-in">
                                <h3 className="font-display text-2xl mb-6">Create New Project</h3>
                                <form onSubmit={handleCreateProject}>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm text-drop-muted mb-2">Project Name *</label>
                                            <input type="text" value={newProjectName} onChange={(e) => setNewProjectName(e.target.value)} className="input-field w-full px-4 py-3 rounded-lg text-drop-light" placeholder="e.g., January Meeting Coordination" required />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-drop-muted mb-2">Description</label>
                                            <textarea value={newProjectDesc} onChange={(e) => setNewProjectDesc(e.target.value)} className="input-field w-full px-4 py-3 rounded-lg text-drop-light resize-none" placeholder="What's this project about?" rows={3} />
                                        </div>
                                    </div>
                                    <div className="flex gap-3 mt-6">
                                        <button type="button" onClick={() => setShowNewProject(false)} className="flex-1 px-4 py-3 rounded-lg border border-white/20 hover:bg-white/5">Cancel</button>
                                        <button type="submit" className="flex-1 btn-primary px-4 py-3 rounded-lg font-medium">Create Project</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                </div>
            );
        };

        // ============ MAIN APP ROUTER ============
        const App = () => {
            const [route, setRoute] = useState({ type: 'dashboard' });

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const taskToken = params.get('task');
                const projectId = params.get('project');

                if (taskToken) {
                    setRoute({ type: 'task', token: taskToken });
                } else if (projectId) {
                    setRoute({ type: 'project', id: projectId });
                } else {
                    setRoute({ type: 'dashboard' });
                }
            }, []);

            if (route.type === 'task') {
                return <TaskCompletionView token={route.token} />;
            }

            if (route.type === 'project') {
                return <ProjectView projectId={route.id} />;
            }

            return <Dashboard />;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
